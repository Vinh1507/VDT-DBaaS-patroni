---
# - name: Update apt cache
#   apt:
#     update_cache: yes

# - name: Install net-tools
#   apt:
#     name: net-tools
#     state: present

# - name: Install PostgreSQL
#   apt:
#     name: postgresql-12
#     state: present

# - name: Install PostgreSQL server development package
#   apt:
#     name: postgresql-server-dev-12
#     state: present


# - name: Stop PostgreSQL service
#   service:
#     name: postgresql
#     state: stopped

# - name: Create symbolic links for PostgreSQL binaries
#   file:
#     src: "/usr/lib/postgresql/12/bin/{{ item }}"
#     dest: "/usr/sbin/{{ item }}"
#     state: link
#   loop:
#     - postgres
#     - pg_ctl
#     - pg_dump
#     - pg_dumpall
#     - pg_restore
#     - psql
#     - reindexdb
#     - vacuumdb

# - name: Install Python and pip3
#   apt:
#     name:
#       - python 
#       - python3-pip
#     state: present

# - name: Install python3-testresources
#   apt:
#     name: python3-testresources
#     state: present

# - name: Upgrade setuptools
#   pip:
#     name: setuptools
#     state: latest

# - name: Install psycopg2
#   pip:
#     name: psycopg2
#     state: present

# - name: Cài đặt Patroni bằng pip
#   pip:
#     name: "patroni[etcd]"
#     state: present

# - name: Install python-etcd
#   pip:
#     name: python-etcd
#     state: present

- name: Tạo nhóm 'patroni' nếu chưa tồn tại
  group:
    name: "{{ patroni_group }}"
    state: present

- name: Tạo user và group cho Patroni
  user:
    name: "{{ patroni_user }}"
    group: "{{ patroni_group }}"
    createhome: yes


- name: Tạo thư mục cho Patroni
  file:
    path: "{{ patroni_install_dir }}"
    state: directory
    owner: "{{ patroni_user }}"
    group: "{{ patroni_group }}"

- name: Tạo tệp cấu hình cho Patroni
  template:
    src: patroni.yml.j2
    dest: "{{ patroni_install_dir }}/patroni.yml"
    owner: "{{ patroni_user }}"
    group: "{{ patroni_group }}"
    mode: 0644

- name: Tạo thư mục /data/patroni
  file:
    path: /data/patroni
    state: directory
    owner: "{{ patroni_user }}"
    group: "{{ patroni_group }}"
    mode: '0700'
    
- name: Tạo service systemd cho Patroni
  template:
    src: patroni.service.j2
    dest: /etc/systemd/system/patroni.service
    mode: '0700'

- name: Khởi động dịch vụ Patroni
  systemd:
    name: patroni
    state: started
    enabled: yes 

- name: Kiểm tra trạng thái của dịch vụ Patroni
  systemd:
    name: patroni
    state: started
  register: patroni_status